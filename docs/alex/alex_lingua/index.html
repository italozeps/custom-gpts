<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alex — lingua.id.lv</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <header class="max-w-5xl mx-auto px-4 pt-10 pb-6">
    <h1 class="text-3xl sm:text-4xl md:text-5xl font-black tracking-tight">Alex — lingua.id.lv</h1>
    <p class="mt-3 text-lg sm:text-xl text-slate-600">
      Converse in your natural language; Perplexity will respond in your chosen language.
    </p>
    <p class="mt-1 text-sm text-amber-700">
      Piezīme: Te saraksts ievietotais var tikt mainīts. Lūdzu, ierosiniet, kas ievietojams, vai precizējams konfigurējot
    </p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-16">
    <!-- Input area -->
    <section class="mb-6">
      <label for="userQuestion" class="block text-sm font-medium text-slate-700 mb-1">Jūsu jautājums / tēma</label>

<!-- CEFR līmeņa kontrole (A/B/C + 1/2) -->
<div class="mt-3 sticky top-0 z-10 bg-slate-50/80 backdrop-blur px-2 py-2 rounded-xl border border-slate-200">
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-center">
    <div>
      <div class="text-xs font-semibold text-slate-600 mb-1">Valodas prasmes līmenis (CEFR)</div>
      <div class="flex items-center gap-3">
        <label class="inline-flex items-center gap-1"><input type="radio" name="cefrLetter" value="A" class="rounded border-slate-300"> <span>A</span></label>
        <label class="inline-flex items-center gap-1"><input type="radio" name="cefrLetter" value="B" class="rounded border-slate-300"> <span>B</span></label>
        <label class="inline-flex items-center gap-1"><input type="radio" name="cefrLetter" value="C" class="rounded border-slate-300"> <span>C</span></label>
        <button id="clearLetter" class="ml-2 text-xs underline text-slate-500">notīrīt</button>
      </div>
    </div>
    <div>
      <div class="text-xs font-semibold text-slate-600 mb-1">Apakšlīmenis</div>
      <div class="flex items-center gap-3">
        <label class="inline-flex items-center gap-1"><input type="radio" name="cefrNumber" value="1" class="rounded border-slate-300"> <span>1</span></label>
        <label class="inline-flex items-center gap-1"><input type="radio" name="cefrNumber" value="2" class="rounded border-slate-300"> <span>2</span></label>
        <button id="clearNumber" class="ml-2 text-xs underline text-slate-500">notīrīt</button>
      </div>
      <p class="text-[11px] text-slate-500 mt-1">Ja izvēlēts tikai skaitlis bez burta, tas tiek ignorēts.</p>
    </div>
    <div class="text-right text-xs text-slate-500">
      <span id="cefrActive"></span>
    </div>
  </div>
</div>

      <textarea id="userQuestion" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:border-slate-400" rows="3" placeholder="Rakstiet šeit brīvā valodā; atbilde būs izvēlētajā valodā."></textarea>
      <div class="mt-2 flex items-center gap-3 text-sm text-slate-600">
        <label class="inline-flex items-center gap-2">
          <input id="openSameTab" type="checkbox" class="rounded border-slate-300" />
          Atvērt tajā pašā cilnē
        </label>
        <button id="clearBtn" class="ml-auto px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">Notīrīt jautājumu</button>
      </div>
    </section>

    <!-- Cards grid -->
    <section>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Cards rendered by JS -->
      </div>
    </section>
  </main>

  <footer class="max-w-5xl mx-auto px-4 pb-10 text-xs text-slate-500">
    <p>Šī lapa ģenerē Perplexity meklēšanas saiti ar iepriekšpievienotu instrukciju piespiest atbildēt izvēlētajā valodā. Jautājums paliek tieši tāds, kā ievadīts augstāk.</p>
  </footer>

  <script id="languages-csv" type="text/csv">
</script>


<script>
  const CSV_URL = 'languages.csv?v=20251110b';
  const PPLX_BASE = 'https://www.perplexity.ai/search?q=';

  const grid = document.querySelector('.grid');
  const qEl = document.getElementById('userQuestion');
  const sameTabEl = document.getElementById('openSameTab');
  document.getElementById('clearBtn').addEventListener('click', () => { qEl.value = ''; qEl.focus(); });

  // Vienkāršs CSV parseris + BOM noņemšana
  function parseCSV(text) {
    // noņem BOM, ja tāds ir
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

    const rows = [];
    let cur = '', row = [], quoted = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i], n = text[i+1];
      if (quoted) {
        if (c === '"' && n === '"') { cur += '"'; i++; }
        else if (c === '"') { quoted = false; }
        else { cur += c; }
      } else {
        if (c === '"') quoted = true;
        else if (c === ',') { row.push(cur); cur = ''; }
        else if (c === '\n' || c === '\r') {
          if (cur.length || row.length) { row.push(cur); rows.push(row); row = []; cur = ''; }
        } else { cur += c; }
      }
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }

    const cleaned = rows.filter(r => r && r.join('').trim().length);
    if (!cleaned.length) return [];

    const header = cleaned[0].map(h => h.trim().replace(/^\uFEFF/, '')); // drošs BOM noņemšana
    const idx = Object.fromEntries(header.map((h, i) => [h, i]));

    const need = ['id','title','subtitle','instruction'];
    const ok = need.every(k => typeof idx[k] === 'number');
    if (!ok) {
      console.error('CSV headers mismatch. Got:', header);
      return [];
    }

    return cleaned.slice(1).map(r => ({
      id: (r[idx.id]||'').trim(),
      title: (r[idx.title]||'').trim(),
      subtitle: (r[idx.subtitle]||'').trim(),
      instruction: (r[idx.instruction]||'').trim(),
    })).filter(x => x.id && x.instruction);
  }

  function buildPerplexityURL(instruction, userQ) {
    const trimmed = (userQ || '').trim();
    const payload = instruction + (trimmed ? "\n\n" + trimmed : '');
    return PPLX_BASE + encodeURIComponent(payload);
  }

  function renderCards(cards) {
    grid.innerHTML = '';
    cards.forEach(cfg => {
      const card = document.createElement('div');
      card.className = 'rounded-2xl border border-slate-200 bg-white p-4 shadow-sm hover:shadow-md transition-shadow';
      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <h3 class="text-lg font-bold">${cfg.title || cfg.id}</h3>
            <p class="text-sm text-slate-600">${cfg.subtitle || ''}</p>
          </div>
          <button data-id="${cfg.id}" class="startBtn inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800 active:scale-[0.98]">Start</button>
        </div>`;
      grid.appendChild(card);
    });
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.startBtn');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const cfg = (window.__CARDS__ || []).find(c => c.id === id);
    if (!cfg) return;
    const url = buildPerplexityURL(cfg.instruction, qEl.value);
    sameTabEl.checked ? (window.location.href = url) : window.open(url, '_blank', 'noopener');
  });

  async function loadCards() {
    try {
      const resp = await fetch(CSV_URL, { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const txt = await resp.text();
      const cards = parseCSV(txt);
      if (cards.length) return cards;
      throw new Error('Parsed 0 cards from external CSV');
    } catch (e) {
      console.warn('Using inline CSV fallback:', e.message || e);
      const inline = document.getElementById('languages-csv');
      const txt = (inline && inline.textContent) ? inline.textContent : '';
      return parseCSV(txt);
    }
  }

  loadCards().then(cards => {
    window.__CARDS__ = cards;
    if (!cards.length) {
      grid.innerHTML = `
        <div class="text-sm text-red-700">
          Kartītes neizdevās ielādēt. Pārbaudi:
          <ul class="list-disc ml-5 mt-2">
            <li><code>languages.csv</code> ceļu (tam jābūt tajā pašā mapē)</li>
            <li>CSV galvenes: <code>id,title,subtitle,instruction</code></li>
            <li>BOM (saglabā kā UTF-8 bez BOM)</li>
          </ul>
          <div class="mt-2"><a class="underline" href="languages.csv" target="_blank">Atvērt languages.csv</a></div>
        </div>`;
      return;
    }
    renderCards(cards);
  }).catch(err => {
    console.error(err);
    grid.innerHTML = '<div class="text-sm text-red-700">Neizdevās ielādēt languages.csv</div>';
  });
</script>

<script>
  // ——— CEFR helperi ———
  function getCEFR() {
    const L = document.querySelector('input[name="cefrLetter"]:checked')?.value || '';
    const N = document.querySelector('input[name="cefrNumber"]:checked')?.value || '';
    if (!L) return '';              // nav burta → nav CEFR
    if (N === '1' || N === '2') return L + N;  // A1/B2 utt.
    return L;                        // tikai A/B/C
  }
  function saveCEFR() {
    sessionStorage.setItem('cefrLetter', document.querySelector('input[name="cefrLetter"]:checked')?.value || '');
    sessionStorage.setItem('cefrNumber', document.querySelector('input[name="cefrNumber"]:checked')?.value || '');
    renderCEFRIndicator();
  }
  function loadCEFR() {
    const L = sessionStorage.getItem('cefrLetter') || '';
    const N = sessionStorage.getItem('cefrNumber') || '';
    if (L) { const el = document.querySelector(`input[name="cefrLetter"][value="${L}"]`); if (el) el.checked = true; }
    if (N) { const el = document.querySelector(`input[name="cefrNumber"][value="${N}"]`); if (el) el.checked = true; }
    renderCEFRIndicator();
  }
  function renderCEFRIndicator() {
    const span = document.getElementById('cefrActive');
    if (!span) return;
    const c = getCEFR();
    span.textContent = c ? `Aktīvs: ${c}` : '';
  }
  document.addEventListener('change', (e) => {
    if (e.target.matches('input[name="cefrLetter"], input[name="cefrNumber"]')) saveCEFR();
  });
  document.getElementById('clearLetter')?.addEventListener('click', () => {
    document.querySelectorAll('input[name="cefrLetter"]').forEach(i => i.checked = false);
    saveCEFR();
  });
  document.getElementById('clearNumber')?.addEventListener('click', () => {
    document.querySelectorAll('input[name="cefrNumber"]').forEach(i => i.checked = false);
    saveCEFR();
  });
  loadCEFR();

  // ——— “uzlīmējam” CEFR klāt esošajam URL veidotājam ———
  (function attachCEFR() {
    const orig = window.buildPerplexityURL; // ja tev jau ir šī funkcija
    window.buildPerplexityURL = function(instruction, userQ) {
      const cefr = getCEFR();
      let instr = instruction || '';
      if (cefr) {
        instr += `\n\nRespond at CEFR level ${cefr}. Use vocabulary and grammar appropriate to this level.`;
      }
      if (typeof orig === 'function') {
        return orig(instr, userQ);
      }
      // Ja kādreiz mainīsies iekšējie nosaukumi, drošības nets:
      const base = (window.PPLX_BASE || 'https://www.perplexity.ai/search?q=');
      const trimmed = (userQ || '').trim();
      const payload = instr + (trimmed ? '\n\n' + trimmed : '');
      return base + encodeURIComponent(payload);
    };
  })();
</script>
  
<script data-goatcounter="https://dainize.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
