<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alex — lingua.id.lv</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <header class="max-w-5xl mx-auto px-4 pt-10 pb-6">
    <h1 class="text-3xl sm:text-4xl md:text-5xl font-black tracking-tight">Alex — lingua.id.lv</h1>
    <p class="mt-3 text-lg sm:text-xl text-slate-600">
      Converse in your natural language; Perplexity will respond in your chosen language.
    </p>
    <p class="mt-1 text-sm text-amber-700">
      Piezīme: Jūs minējāt “12” valodu kartītes, bet sarakstā ir 13. Zemāk iekļautas visas 13; pasakiet, ja jāizņem kāda.
    </p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-16">
    <!-- Input area -->
    <section class="mb-6">
      <label for="userQuestion" class="block text-sm font-medium text-slate-700 mb-1">Jūsu jautājums / tēma</label>
      <textarea id="userQuestion" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:border-slate-400" rows="3" placeholder="Rakstiet šeit brīvā valodā; atbilde būs izvēlētajā valodā."></textarea>
      <div class="mt-2 flex items-center gap-3 text-sm text-slate-600">
        <label class="inline-flex items-center gap-2">
          <input id="openSameTab" type="checkbox" class="rounded border-slate-300" />
          Atvērt tajā pašā cilnē
        </label>
        <button id="clearBtn" class="ml-auto px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">Notīrīt jautājumu</button>
      </div>
    </section>

    <!-- Cards grid -->
    <section>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Cards rendered by JS -->
      </div>
    </section>
  </main>

  <footer class="max-w-5xl mx-auto px-4 pb-10 text-xs text-slate-500">
    <p>Šī lapa ģenerē Perplexity meklēšanas saiti ar iepriekšpievienotu instrukciju piespiest atbildēt izvēlētajā valodā. Jautājums paliek tieši tāds, kā ievadīts augstāk.</p>
  </footer>

  <script>
  // === CONFIG ===
  const CSV_URL = 'languages.csv';
  const PPLX_BASE = 'https://www.perplexity.ai/search?q=';

  // UI refs
  const grid = document.querySelector('.grid');
  const qEl = document.getElementById('userQuestion');
  const sameTabEl = document.getElementById('openSameTab');
  document.getElementById('clearBtn').addEventListener('click', () => { qEl.value = ''; qEl.focus(); });

  // --- CSV parser (handles quotes, commas, newlines) ---
  function parseCSV(text) {
    const rows = [];
    let cur = '', row = [], q = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i], n = text[i+1];
      if (q) {
        if (c === '"' && n === '"') { cur += '"'; i++; }
        else if (c === '"') { q = false; }
        else { cur += c; }
      } else {
        if (c === '"') q = true;
        else if (c === ',') { row.push(cur); cur = ''; }
        else if (c === '
' || c === '
') {
          if (cur.length || row.length) { row.push(cur); rows.push(row); row = []; cur = ''; }
        } else { cur += c; }
      }
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }
    // headers
    const [hdr, ...data] = rows.filter(r => r.length && r.join('').trim().length);
    const idx = Object.fromEntries(hdr.map((h, i) => [h.trim(), i]));
    return data.map(r => ({
      id: r[idx.id]?.trim() || '',
      title: r[idx.title]?.trim() || '',
      subtitle: r[idx.subtitle]?.trim() || '',
      instruction: r[idx.instruction]?.trim() || ''
    })).filter(x => x.id && x.instruction);
  }

  function buildPerplexityURL(instruction, userQ) {
    const trimmed = (userQ || '').trim();
    const payload = instruction + (trimmed ? "

" + trimmed : '');
    return PPLX_BASE + encodeURIComponent(payload);
  }

  function renderCards(cards) {
    grid.innerHTML = '';
    cards.forEach(cfg => {
      const card = document.createElement('div');
      card.className = 'rounded-2xl border border-slate-200 bg-white p-4 shadow-sm hover:shadow-md transition-shadow';
      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <h3 class="text-lg font-bold">${cfg.title || cfg.id}</h3>
            <p class="text-sm text-slate-600">${cfg.subtitle || ''}</p>
          </div>
          <button data-id="${cfg.id}" class="startBtn inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800 active:scale-[0.98]">Start</button>
        </div>`;
      grid.appendChild(card);
    });
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.startBtn');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const cfg = window.__CARDS__.find(c => c.id === id);
    if (!cfg) return;
    const url = buildPerplexityURL(cfg.instruction, qEl.value);
    if (sameTabEl.checked) window.location.href = url; else window.open(url, '_blank', 'noopener');
  });

  // Load CSV and boot
  fetch(CSV_URL)
    .then(r => r.text())
    .then(parseCSV)
    .then(cards => { window.__CARDS__ = cards; renderCards(cards); })
    .catch(err => {
      console.error('CSV load error', err);
      grid.innerHTML = '<div class="text-sm text-red-700">Neizdevās ielādēt languages.csv</div>';
    });
</script>
</body>
</html>
