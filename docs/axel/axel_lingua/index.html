<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alex — lingua.id.lv</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <header class="max-w-5xl mx-auto px-4 pt-10 pb-6">
    <h1 class="text-3xl sm:text-4xl md:text-5xl font-black tracking-tight">Alex — lingua.id.lv</h1>
    <p class="mt-3 text-lg sm:text-xl text-slate-600">
      Converse in your natural language; Perplexity will respond in your chosen language.
    </p>
    <p class="mt-1 text-sm text-amber-700">
      Piezīme: Te saraksts ievietotais var tikt mainīts. Lūdzu, ierosiniet, kas ievietojams, vai precizējams konfigurējot
    </p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-16">
    <!-- Input area -->
    <section class="mb-6">
      <label for="userQuestion" class="block text-sm font-medium text-slate-700 mb-1">Jūsu jautājums / tēma</label>

      <!-- CEFR līmeņa izvēle (vienkāršie radio) -->
      <div id="cefrLevels" class="mb-2">
        <label><input type="radio" name="cefrLevel" value="A1" checked> A1</label>
        <label><input type="radio" name="cefrLevel" value="A2"> A2</label>
        <label><input type="radio" name="cefrLevel" value="B1"> B1</label>
        <label><input type="radio" name="cefrLevel" value="B2"> B2</label>
        <label><input type="radio" name="cefrLevel" value="C1"> C1</label>
        <label><input type="radio" name="cefrLevel" value="C2"> C2</label>
      </div>

      <textarea id="userQuestion" class="w-full rounded-xl border border-slate-300 p-3 focus:outline-none focus:ring-2 focus:ring-sky-400" rows="3" placeholder="Ierakstiet šeit brīvā valodā; atbilde būs izvēlētajā valodā."></textarea>
      <div class="mt-2 flex items-center gap-3 text-sm text-slate-600">
        <label class="inline-flex items-center gap-2">
          <input id="openSameTab" type="checkbox" class="rounded border-slate-300" />
          Atvērt tajā pašā cilnē
        </label>
        <button id="clearBtn" class="text-xs underline">Notīrīt jautājumu</button>
      </div>
    </section>

    <!-- Kartīšu saraksts -->
    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Kartītes</h2>
        <div class="text-xs text-slate-500">languages.csv</div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <!-- Cards rendered by JS -->
      </div>
    </section>
  </main>

  <footer class="max-w-5xl mx-auto px-4 pb-10 text-xs text-slate-500">
    <div id="cefrIndicator" class="flex items-center gap-2">
      <span class="font-semibold">CEFR:</span>
      <span id="cefrActive" class="inline-block px-2 py-0.5 rounded-full bg-slate-200"></span>
    </div>
    <div class="mt-2" id="cefrChips"></div>
  </footer>

<script>
  // ——— Helper: fetch CSV un parse ———
  async function fetchText(url) {
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error(`Fetch failed ${r.status} for ${url}`);
    return await r.text();
  }

  function parseCSV(text) {
    // Vienkāršs CSV parseris ar pēdiņām
    const rows = [];
    let cur = '', row = [], quoted = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      if (c === '"') {
        if (quoted && text[i + 1] === '"') { cur += '"'; i++; }
        else quoted = !quoted;
      } else if (!quoted && (c === ',' || c === '\n' || c === '\r')) {
        row.push(cur); cur = '';
        if (c === '\n' || c === '\r') { if (row.length) rows.push(row); row = []; }
      } else {
        cur += c;
      }
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }

    if (!rows.length) return [];
    const header = rows[0].map(h => h.trim().toLowerCase());
    const idx = {
      id: header.indexOf('id'),
      title: header.indexOf('title'),
      subtitle: header.indexOf('subtitle'),
      instruction: header.indexOf('instruction'),
    };
    const out = [];
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      if (!r.length) continue;
      out.push({
        id: r[idx.id] || String(i),
        title: r[idx.title] || '',
        subtitle: r[idx.subtitle] || '',
        instruction: r[idx.instruction] || ''
      });
    }
    return out.filter(x => x.title || x.subtitle || x.instruction);
  }

  // ——— Render kartītes ———
  function cardHTML(item) {
    const q = document.getElementById('userQuestion')?.value || '';
    const href = buildPerplexityURL(item.instruction, q);
    const sameTab = document.getElementById('openSameTab')?.checked;
    const target = sameTab ? '_self' : '_blank';
    const rel = sameTab ? '' : 'noopener noreferrer';

    return `
      <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm hover:shadow-md transition">
        <h3 class="font-semibold text-slate-800">${escapeHTML(item.title || '')}</h3>
        <p class="text-sm text-slate-600 mt-1">${escapeHTML(item.subtitle || '')}</p>

        <div class="mt-3 flex items-center gap-2">
          <a href="${href}" target="${target}" rel="${rel}"
             class="inline-flex items-center gap-2 rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-50">
            <span>Perplexity</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
          </a>

          <button data-id="${escapeAttr(item.id)}"
                  class="copy-btn inline-flex items-center gap-2 rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-50"
                  title="Iekopēt instrukciju starpliktuvē">
            Kopēt instrukciju
          </button>
        </div>
      </article>
    `;
  }

  function escapeHTML(s) {
    return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;'); }

  async function renderCards() {
    const grid = document.querySelector('main section .grid');
    if (!grid) return;
    grid.innerHTML = '<div class="text-sm text-slate-500">Ielādē...</div>';
    try {
      const txt = await fetchText('languages.csv');
      const rows = parseCSV(txt);
      if (!rows.length) {
        grid.innerHTML = '<div class="text-sm text-amber-600">languages.csv ir tukšs vai bez vajadzīgajām kolonnām.</div>';
        return;
      }
      grid.innerHTML = rows.map(cardHTML).join('');
      bindCopyButtons(rows);
    } catch (e) {
      grid.innerHTML = `<div class="text-sm text-rose-600">Neizdevās ielādēt languages.csv: ${escapeHTML(String(e))}</div>`;
    }
  }

  function bindCopyButtons(rows) {
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        const row = rows.find(x => x.id == id);
        if (!row) return;
        try {
          await navigator.clipboard.writeText(row.instruction || '');
          btn.textContent = 'Nokopēts!';
          setTimeout(() => { btn.textContent = 'Kopēt instrukciju'; }, 1200);
        } catch (e) {
          alert('Neizdevās kopēt instrukciju: ' + e);
        }
      });
    });
  }

  // Input UI
  document.getElementById('clearBtn')?.addEventListener('click', () => {
    const ta = document.getElementById('userQuestion');
    if (ta) ta.value = '';
  });

  // Render sākumā
  renderCards();

  // Ja mainās checkbox vai teksts, nepārzīmējam; Perplexity URL top dinamiski pie click/atvēršanas

  // ——— CEFR helperi ———
  const CEFR_LEVELS = ["A1","A2","B1","B2","C1","C2"];

  function getCEFR() {
    return sessionStorage.getItem('cefrLevel') || '';
  }
  function setCEFR(val) {
    sessionStorage.setItem('cefrLevel', val || '');
    renderCEFRIndicator();
  }

  function renderCEFRIndicator() {
    const span = document.getElementById('cefrActive');
    if (!span) return;
    const c = getCEFR();
    span.textContent = c ? `Aktīvs: ${c}` : '';
  }
  function renderCEFRChips() {
    const box = document.getElementById('cefrChips');
    if (!box) return;
    box.innerHTML = '';
    const active = getCEFR();
    CEFR_LEVELS.forEach(lv => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className =
        'px-3 py-1.5 rounded-full border text-sm ' +
        (active === lv ? 'bg-slate-800 text-white' : 'bg-white text-slate-700 hover:bg-slate-50');
      btn.textContent = lv;
      btn.addEventListener('click', () => {
        setCEFR(lv);
        // arī atjauninām radio
        const r = document.querySelector(`input[name="cefrLevel"][value="${lv}"]`);
        if (r) r.checked = true;
      });
      box.appendChild(btn);
    });

    // sasaistām radio pogas
    document.querySelectorAll('input[name="cefrLevel"]').forEach(r => {
      r.addEventListener('change', (ev) => {
        const v = ev.target.value;
        setCEFR(v);
      });
    });
  }

  // inicializācija
  renderCEFRChips();
  renderCEFRIndicator();

  window.buildPerplexityURL = function(instruction, userQ) {
    // Always read CEFR from the checked radio button, not storage!
    const cefr = document.querySelector('input[name="cefrLevel"]:checked')?.value || '';
    let instr = instruction || '';
    if (cefr) {
      instr += `\n\nRespond at CEFR level ${cefr}. Use vocabulary and grammar appropriate to this level.`;
    }
    const base = (window.PPLX_BASE || 'https://www.perplexity.ai/search?q=');
    const trimmed = (userQ || '').trim();
    const payload = instr + (trimmed ? '\n\n' + trimmed : '');
    return base + encodeURIComponent(payload);
  };
</script>

<script data-goatcounter="https://dainize.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
