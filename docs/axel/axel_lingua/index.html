<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Axel — lingua.id.lv (safe)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <header class="max-w-5xl mx-auto px-4 pt-10 pb-6">
    <h1 class="text-3xl sm:text-4xl md:text-5xl font-black tracking-tight">Axel — lingua.id.lv</h1>
    <p class="mt-3 text-lg sm:text-xl text-slate-600">
      Converse in your natural language; Perplexity will respond in your chosen language level.
    </p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-16">
    <section class="mb-6">
      <label for="userQuestion" class="block text-sm font-medium text-slate-700 mb-1">Jūsu jautājums / tēma</label>

      <div id="cefrLevels" class="mb-2 flex flex-wrap gap-3">
        <label class="inline-flex items-center gap-1"><input type="radio" name="cefrLevel" value="A1"> A1</label>
        <label class="inline-flex items-center gap-1"><input type="radio" name="cefrLevel" value="A2"> A2</label>
        <label class="inline-flex items-center gap-1"><input type="radio" name="cefrLevel" value="B1"> B1</label>
        <label class="inline-flex items-center gap-1"><input type="radio" name="cefrLevel" value="B2"> B2</label>
        <label class="inline-flex items-center gap-1"><input type="radio" name="cefrLevel" value="C1"> C1</label>
         <label class="inline-flex items-center gap-1"<input type="radio" name="cefrLevel" value="C2" checked> C2</label>
      </div>

      <textarea id="userQuestion" class="w-full rounded-xl border border-slate-300 p-3 focus:outline-none focus:ring-2 focus:ring-sky-400" rows="3" placeholder="Ierakstiet šeit brīvā valodā; atbilde būs izvēlētajā CEFR līmenī."></textarea>
      <div class="mt-2 flex items-center gap-3 text-sm text-slate-600">
        <label class="inline-flex items-center gap-2">
          <input id="openSameTab" type="checkbox" class="rounded border-slate-300" />
          Atvērt tajā pašā cilnē
        </label>
        <button id="clearBtn" class="text-xs underline">Notīrīt jautājumu</button>
      </div>
    </section>

    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Kartītes</h2>
        <div class="text-xs text-slate-500">languages.csv</div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3" id="cardsGrid">
      </div>
    </section>
  </main>

  <footer class="max-w-5xl mx-auto px-4 pb-10 text-xs text-slate-500">
    <div id="cefrIndicator" class="flex items-center gap-2">
      <span class="font-semibold">CEFR:</span>
      <span id="cefrActive" class="inline-block px-2 py-0.5 rounded-full bg-slate-200"></span>
    </div>
    <div class="mt-2" id="cefrChips"></div>
  </footer>

<script type="text/javascript">
(function(){
  function fetchText(url) {
    return fetch(url, { cache: 'no-store' }).then(function(r){
      if (!r.ok) throw new Error('Fetch failed ' + r.status + ' for ' + url);
      return r.text();
    });
  }

  function parseCSV(text) {
    var rows = [];
    var cur = '', row = [], quoted = false;
    for (var i = 0; i < text.length; i++) {
      var c = text[i];
      if (c === '"') {
        if (quoted && text[i + 1] === '"') { cur += '"'; i++; }
        else quoted = !quoted;
      } else if (!quoted && (c === ',' || c === '\n' || c === '\r')) {
        row.push(cur); cur = '';
        if (c === '\n' || c === '\r') { if (row.length) rows.push(row); row = []; }
      } else {
        cur += c;
      }
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }

    if (!rows.length) return [];
    var header = rows[0].map(function(h){ return h.trim().toLowerCase(); });
    var idx = {
      id: header.indexOf('id'),
      title: header.indexOf('title'),
      subtitle: header.indexOf('subtitle'),
      instruction: header.indexOf('instruction')
    };
    var out = [];
    for (var j = 1; j < rows.length; j++) {
      var r = rows[j]; if (!r.length) continue;
      out.push({
        id: (idx.id >= 0 ? r[idx.id] : String(j)),
        title: (idx.title >= 0 ? r[idx.title] : ''),
        subtitle: (idx.subtitle >= 0 ? r[idx.subtitle] : ''),
        instruction: (idx.instruction >= 0 ? r[idx.instruction] : '')
      });
    }
    return out.filter(function(x){ return x.title || x.subtitle || x.instruction; });
  }

  function esc(s){
    return String(s || '').replace(/[&<>\"']/g, function(m){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

 function cardHTML(item) {
  var html = '';
  html += '<article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm hover:shadow-md transition">';
  html +=   '<h3 class="font-semibold text-slate-800">' + esc(item.title || '') + '</h3>';
  html +=   '<p class="text-sm text-slate-600 mt-1">' + esc(item.subtitle || '') + '</p>';
  html +=   '<div class="mt-3 flex items-center gap-2">';
  html +=     '<a href="#" class="pplx-link inline-flex items-center gap-2 rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-50" data-instr="' + esc(item.instruction || '') + '">';
  html +=       '<span>Start</span>';   // ← šeit vari ielikt “Perplexity” vai citu tekstu
  html +=     '</a>';
  html +=   '</div>';
  html += '</article>';
  return html;
}
  function bindCopyButtons(rows) {
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.textContent = 'Copy conversation';  // vai “Atskaņot sarunu”, ja gribi latviski
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      const row = rows.find(x => x.id == id);
      if (!row) return;

      // Šeit ievieto savu saiti uz sarunu — pagaidām piemērs:
      const convoUrl = row.subtitle || ''; // vai cita kolonna CSV
      if (convoUrl) {
        window.open(convoUrl, '_blank', 'noopener,noreferrer');
      } else {
        alert('Sarunas saite nav norādīta.');
      }
    });
  });
}


  function buildURL(instruction, userQ, cefr) {
    var instr = instruction || '';
    if (cefr) {
      instr += '\n\nRespond at CEFR level ' + cefr + '. Use vocabulary and grammar appropriate to this level.';
    }
    var base = (window.PPLX_BASE || 'https://www.perplexity.ai/search?q=');
    var payload = instr + (userQ ? '\n\n' + userQ : '');
    return base + encodeURIComponent(payload);
  }

  document.addEventListener('click', function(ev){
    var link = ev.target.closest ? ev.target.closest('.pplx-link') : null;
    if (!link) return;
    ev.preventDefault();
    var instruction = link.getAttribute('data-instr') || '';
    var userQel = document.getElementById('userQuestion');
    var userQ = userQel ? (userQel.value || '').trim() : '';
    var r = document.querySelector('input[name="cefrLevel"]:checked');
    var cefr = r ? r.value : '';
    var url = buildURL(instruction, userQ, cefr);
    var sameTabEl = document.getElementById('openSameTab');
    var sameTab = sameTabEl && sameTabEl.checked;
    if (sameTab) window.location.href = url;
    else window.open(url, '_blank', 'noopener,noreferrer');
  });

  function renderCards() {
    var grid = document.getElementById('cardsGrid');
    if (!grid) return;
    grid.innerHTML = '<div class="text-sm text-slate-500">Ielādē...</div>';
    fetchText('languages.csv').then(function(txt){
      var rows = parseCSV(txt);
      if (!rows.length) {
        grid.innerHTML = '<div class="text-sm text-amber-600">languages.csv ir tukšs vai bez vajadzīgajām kolonnām.</div>';
        return;
      }
      var html = rows.map(cardHTML).join('');
      grid.innerHTML = html;
      bindCopyButtons(rows);
    }).catch(function(e){
      grid.innerHTML = '<div class="text-sm text-rose-600">Neizdevās ielādēt languages.csv: ' + esc(String(e)) + '</div>';
    });
  }

  // CEFR indikatoru palīdzfunkcijas
  var CEFR_LEVELS = ['A1','A2','B1','B2','C1','C2'];
  function setCEFR(val) {
    try { sessionStorage.setItem('cefrLevel', val || ''); } catch(e){}
    renderCEFRIndicator();
  }
  function getCEFR() {
    try { return sessionStorage.getItem('cefrLevel') || ''; } catch(e){ return ''; }
  }
  function renderCEFRIndicator() {
    var span = document.getElementById('cefrActive');
    if (!span) return;
    var r = document.querySelector('input[name="cefrLevel"]:checked');
    var c = r ? r.value : getCEFR();
    span.textContent = c ? ('Aktīvs: ' + c) : '';
  }
  function renderCEFRChips() {
    var box = document.getElementById('cefrChips');
    if (!box) return;
    box.innerHTML = '';
    var active = (document.querySelector('input[name="cefrLevel"]:checked') || {}).value || getCEFR();
    CEFR_LEVELS.forEach(function(lv){
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'px-3 py-1.5 rounded-full border text-sm ' + (active === lv ? 'bg-slate-800 text-white' : 'bg-white text-slate-700 hover:bg-slate-50');
      btn.textContent = lv;
      btn.addEventListener('click', function(){
        var r = document.querySelector('input[name="cefrLevel"][value="' + lv + '"]');
        if (r) r.checked = true;
        setCEFR(lv);
        renderCEFRChips();
      });
      box.appendChild(btn);
    });

    var radios = document.querySelectorAll('input[name="cefrLevel"]');
    Array.prototype.forEach.call(radios, function(radio){
      radio.addEventListener('change', function(ev){
        setCEFR(ev.target.value);
        renderCEFRChips();
      });
    });
  }

  document.getElementById('clearBtn') && document.getElementById('clearBtn').addEventListener('click', function(){
    var ta = document.getElementById('userQuestion'); if (ta) ta.value='';
  });

  // Start
  renderCards();
  renderCEFRChips();
  renderCEFRIndicator();
})();
</script>

<script data-goatcounter="https://dainize.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
